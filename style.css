<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>米埔支出管理 2026</title>
    <style>
        :root {
            --primary-bg: #fcf8e3;
            --header-bg: #f7e1a0;
            --summary-blue: #00ffff;
            --summary-grey: #d9d9d9;
            --summary-green: #90ee90;
        }
        body { font-family: -apple-system, system-ui; background: var(--primary-bg); margin: 0; padding: 15px; padding-bottom: 50px; }
        h2 { font-size: 1.2rem; border-left: 5px solid #f0ad4e; padding-left: 10px; margin-bottom: 15px; }

        /* 表單佈局 */
        .form-section { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .form-row { display: flex; gap: 20px; margin-bottom: 12px; flex-wrap: wrap; }
        .input-group { width: 200px; } /* 固定寬度 200px */
        .full-width { width: 100%; max-width: 420px; margin-bottom: 12px; } /* 配合兩行 200px + gap */

        label { font-size: 12px; color: #666; display: block; margin-bottom: 3px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; background: white; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; max-width: 420px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-add { background: #5cb85c; color: white; }
        .btn-update { background: #4a90e2; color: white; display: none; }

        /* 顯示區樣式 */
        .net-display { background: #fff; padding: 10px; border-radius: 5px; border: 2px solid #f0ad4e; margin-bottom: 10px; text-align: center; font-weight: bold; font-size: 1.1rem; max-width: 420px; }
        .table-wrapper { overflow-x: auto; background: #fff; border: 1px solid #ddd; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
        th { background: var(--header-bg); position: sticky; top: 0; }
        
        .summary-container { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .summary-card { padding: 12px; border-radius: 8px; font-size: 14px; line-height: 1.6; min-height: 100px; }
        .blue-card { background: var(--summary-blue); border: 1px solid #00cccc; }
        .grey-card { background: var(--summary-grey); border: 1px solid #bbb; }
        .green-card { background: var(--summary-green); border: 1px solid #77cc77; }
        
        .settled { background-color: #f9f9f9; color: #aaa; }
        .btn-del { background: #ff4d4d; color: white; border: none; padding: 4px 6px; border-radius: 4px; }
    </style>
</head>
<body>

    <h2>米埔支出管理 2026</h2>

    <div class="form-section">
        <div class="full-width">
            <label>詳情</label>
            <input type="text" id="details" placeholder="輸入詳情內容">
        </div>

        <div class="form-row">
            <div class="input-group">
                <label>日期</label>
                <input type="date" id="date">
            </div>
            <div class="input-group">
                <label>類別</label>
                <select id="category">
                    <option value="Medical">Medical</option>
                    <option value="Medicine">Medicine</option>
                    <option value="Contribution">Contribution</option>
                    <option value="Domestic Helper">Domestic Helper</option>
                    <option value="Home">Home</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="input-group">
                <label>金額 ($)</label>
                <input type="number" id="expense" placeholder="0">
            </div>
            <div class="input-group">
                <label>預付/存入者</label>
                <select id="person">
                    <option value="">選擇人員</option>
                    <option value="Josephine">Josephine</option>
                    <option value="Thomas">Thomas</option>
                    <option value="Kelvin">Kelvin</option>
                    <option value="Sylvia">Sylvia</option>
                    <option value="Kathy">Kathy</option>
                    <option value="Charles">Charles</option>
                    <option value="Matthew">Matthew</option>
                    <option value="Edward">Edward</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="input-group">
                <label>收回日期</label>
                <input type="date" id="receiveDate">
            </div>
            <div class="input-group">
                <label>收回途徑</label>
                <input type="text" id="receiveMethod" placeholder="例如：轉帳">
            </div>
        </div>

        <div class="full-width">
            <label>備註</label>
            <textarea id="remarks" style="height:40px;"></textarea>
        </div>

        <div class="btn-group">
            <button id="addBtn" class="btn-add" onclick="addRecord()">新增記錄</button>
            <button id="updateBtn" class="btn-update" onclick="updateRecord()">完成修改</button>
        </div>
    </div>

    <div class="net-display" id="netAmountDisplay">結餘淨額: $0</div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>選取</th>
                    <th>日期</th>
                    <th>詳情</th>
                    <th>金額</th>
                    <th>人員</th>
                    <th>收回日期</th>
                    <th>途徑</th>
                    <th>備註</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="dataList"></tbody>
        </table>
    </div>

    <div class="summary-container">
        <div class="summary-card blue-card">
            <strong>2026 尚未收回預付：</strong>
            <div id="outstandingSummary"></div>
        </div>
        <div class="summary-card green-card">
            <strong>各人 Contribution 總額：</strong>
            <div id="contributionSummary"></div>
        </div>
        <div class="summary-card grey-card">
            <strong>選取項目合計：</strong>
            <div id="selectedTotal" style="font-size: 1.2rem; font-weight: bold;">$0</div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('maipo_db')) || [];
        let editId = null;
        const people = ["Josephine", "Thomas", "Kelvin", "Sylvia", "Kathy", "Charles", "Matthew", "Edward"];

        document.getElementById('date').valueAsDate = new Date();

        function render() {
            const list = document.getElementById('dataList');
            list.innerHTML = '';
            let selectedSum = 0;
            let netTotal = 0;
            let contriMap = {};
            let outstandingMap = {};
            people.forEach(p => { contriMap[p] = 0; outstandingMap[p] = 0; });

            db.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((item) => {
                if (item.category === "Contribution") {
                    netTotal += item.expense;
                    if (contriMap.hasOwnProperty(item.person)) contriMap[item.person] += item.expense;
                } else {
                    netTotal -= item.expense;
                    if (!item.receiveDate && outstandingMap.hasOwnProperty(item.person)) {
                        outstandingMap[item.person] += item.expense;
                    }
                }
                if (item.checked) selectedSum += item.expense;

                const tr = document.createElement('tr');
                if (item.receiveDate) tr.className = 'settled';
                tr.innerHTML = `
                    <td><input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleCheck('${item.id}')"></td>
                    <td>${item.date.substring(5)}</td>
                    <td>${item.details}</td>
                    <td style="color:${item.category==='Contribution'?'green':'red'}; font-weight:bold">$${item.expense.toLocaleString()}</td>
                    <td>${item.person}</td>
                    <td>${item.receiveDate || '-'}</td>
                    <td>${item.receiveMethod || '-'}</td>
                    <td>${item.remarks || ''}</td>
                    <td><button onclick="editRecord('${item.id}')">改</button> <button class="btn-del" onclick="deleteRecord('${item.id}')">刪</button></td>
                `;
                list.appendChild(tr);
            });

            document.getElementById('netAmountDisplay').innerText = `目前結餘淨額 (Net): $${netTotal.toLocaleString()}`;
            document.getElementById('selectedTotal').innerText = `$${selectedSum.toLocaleString()}`;
            
            document.getElementById('outstandingSummary').innerHTML = people.map(p => `${p}: <span style="float:right">$${outstandingMap[p].toLocaleString()}</span>`).join('<br>');
            document.getElementById('contributionSummary').innerHTML = people.map(p => contriMap[p] > 0 ? `${p}: <span style="float:right">$${contriMap[p].toLocaleString()}</span>` : '').filter(s => s !== '').join('<br>');

            localStorage.setItem('maipo_db', JSON.stringify(db));
        }

        function addRecord() {
            const newItem = {
                id: 'id' + Date.now(),
                date: document.getElementById('date').value,
                details: document.getElementById('details').value,
                category: document.getElementById('category').value,
                expense: parseFloat(document.getElementById('expense').value) || 0,
                person: document.getElementById('person').value,
                receiveDate: document.getElementById('receiveDate').value,
                receiveMethod: document.getElementById('receiveMethod').value,
                remarks: document.getElementById('remarks').value,
                checked: false
            };
            if(!newItem.details || !newItem.person) { alert("請填寫詳情及選擇人員"); return; }
            db.push(newItem);
            resetForm();
            render();
        }

        function editRecord(id) {
            const item = db.find(i => i.id === id);
            editId = id;
            ['date','details','category','expense','person','receiveDate','receiveMethod','remarks'].forEach(key => {
                document.getElementById(key).value = item[key] || '';
            });
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'block';
            window.scrollTo(0,0);
        }

        function updateRecord() {
            const index = db.findIndex(i => i.id === editId);
            ['date','details','category','expense','person','receiveDate','receiveMethod','remarks'].forEach(key => {
                db[index][key] = key === 'expense' ? parseFloat(document.getElementById(key).value) : document.getElementById(key).value;
            });
            editId = null;
            resetForm();
            render();
            document.getElementById('addBtn').style.display = 'block';
            document.getElementById('updateBtn').style.display = 'none';
        }

        function deleteRecord(id) { if(confirm("確定刪除？")) { db = db.filter(i => i.id !== id); render(); } }
        function toggleCheck(id) { const index = db.findIndex(i => i.id === id); db[index].checked = !db[index].checked; render(); }
        function resetForm() { ['details','expense','receiveDate','receiveMethod','remarks'].forEach(id => document.getElementById(id).value = ''); }

        render();
    </script>
</body>
</html>
